# ============================================================
# GitHub Actions - Deploy to VPS Contabo
# ============================================================
# Chaque push vers main ou dev declenche un deploiement sur le VPS
# Flow: SSH → git pull → docker compose build → docker compose up -d

name: Deploy to VPS

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "service=shopify-app" >> $GITHUB_OUTPUT
            echo "container=shopify_app_prod" >> $GITHUB_OUTPUT
            echo "branch=main" >> $GITHUB_OUTPUT
          else
            echo "service=shopify-app-staging" >> $GITHUB_OUTPUT
            echo "container=shopify_app_staging" >> $GITHUB_OUTPUT
            echo "branch=dev" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script_stop: true
          script: |
            set -e
            echo "=== Deploying ${{ steps.env.outputs.branch }} ==="
            echo "Commit: ${{ github.sha }}"

            # 1. Pull le code source
            cd /root/docker-stack-cyrus/shopify-logistics-app
            git fetch origin
            git checkout ${{ steps.env.outputs.branch }}
            git pull origin ${{ steps.env.outputs.branch }}

            # 2. Build et redemarrer le container cible depuis le docker-compose principal
            cd /root/docker-stack-cyrus
            docker compose build ${{ steps.env.outputs.service }} --no-cache
            docker compose up -d ${{ steps.env.outputs.service }}

            # 3. Executer les migrations Prisma
            sleep 5
            docker exec ${{ steps.env.outputs.container }} npx prisma migrate deploy || true

            # 4. Cleanup des anciennes images
            docker image prune -f

            echo "=== Deploy ${{ steps.env.outputs.branch }} complete ==="
