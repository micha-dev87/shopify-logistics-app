// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Using PostgreSQL for production deployment
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// Shopify Session Storage (managed by @shopify/shopify-app-session-storage-prisma)
// DO NOT MODIFY - required by Shopify App Remix template
// ============================================================

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

// ============================================================
// Application Models - Multi-tenant via shopId
// ============================================================

model Shop {
  id          String   @id @default(cuid())
  domain      String   @unique  // myshop.myshopify.com
  name        String
  plan        String?  // billing plan: Basique, Gold, Pro
  accessToken String   // Shopify API access token
  isActive    Boolean  @default(true)
  
  // Telegram configuration
  telegramBotToken    String?  // Bot token for sending notifications
  telegramWebhookSet  Boolean  @default(false)
  
  // WhatsApp widget configuration
  whatsappNumber   String?  // Support WhatsApp number
  whatsappMessage  String?  // Default message for widget
  widgetEnabled    Boolean  @default(true)
  
  // WhatsApp notification configuration (Baileys)
  notificationMode    NotificationMode @default(TELEGRAM)  // TELEGRAM, WHATSAPP, BOTH
  whatsappEnabled     Boolean  @default(false)
  whatsappConnectedAt DateTime?
  whatsappPhone       String?  // Phone number of connected WhatsApp account
  
  // Rate limiting tracking
  whatsappDailyCount  Int      @default(0)
  whatsappCountDate   DateTime?  // Date of last count reset
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deliveryAgents  DeliveryAgent[]
  deliveryBills   DeliveryBill[]
  whatsappSession WhatsAppSession?

  @@index([domain])
}

model DeliveryAgent {
  id             String    @id @default(cuid())
  shopId         String
  name           String
  phone          String    // Phone number for WhatsApp/contact
  country        String    // ISO country code (e.g., "CI")
  city           String?
  role           AgentRole @default(COURIER)
  telegramUserId String?   // Telegram user ID for bot notifications
  whatsappJid    String?   // WhatsApp JID for notifications (e.g., "22507070707@s.whatsapp.net")
  isActive       Boolean   @default(true)
  showInWidget   Boolean   @default(false) // Whether this agent appears in the WhatsApp widget
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  shop          Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  deliveryBills DeliveryBill[]

  @@index([shopId, country, city, isActive])
  @@index([shopId, isActive])
}

// WhatsApp session for Baileys authentication persistence
model WhatsAppSession {
  id           String   @id @default(cuid())
  shopId       String   @unique
  creds        Json     // Baileys credentials (encrypted)
  keys         Json     // Signal protocol keys
  connected    Boolean  @default(false)
  phoneNumber  String?  // Connected WhatsApp phone number
  lastQr       String?  // Last generated QR code (temporary)
  qrExpiry     DateTime? // QR code expiration time
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
}

model DeliveryBill {
  id              String   @id @default(cuid())
  shopId          String
  orderId         String   @unique  // Shopify order ID - idempotency key
  orderName       String?  // Shopify order name (#1001, etc.)
  customerName    String
  customerAddress String
  customerPhone   String?

  assignedAgentId String?
  assignedAgent   DeliveryAgent? @relation(fields: [assignedAgentId], references: [id], onDelete: SetNull)

  productTitle    String
  productImage    String?
  productQuantity Int

  status          DeliveryStatus @default(PENDING)
  statusHistory   Json?          // [{status, timestamp, agent?}]

  deliveryNotes     String?
  deliveryPhoto     String?
  telegramNotified  Boolean  @default(false)
  telegramMessageId String?  // For callback updates

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, status])
  @@index([shopId, createdAt])
  @@index([assignedAgentId])
}

// ============================================================
// Enums
// ============================================================

enum AgentRole {
  COURIER  // Livreur - receives order notifications
  SUPPORT  // Service Client - appears in WhatsApp widget
  BOTH     // Both roles
}

enum DeliveryStatus {
  PENDING       // Awaiting assignment
  ASSIGNED      // Assigned to a delivery agent
  IN_PROGRESS   // Picked up by agent
  DELIVERED     // Successfully delivered
  NOT_DELIVERED // Delivery failed
  CANCELLED     // Order cancelled
}

enum NotificationMode {
  TELEGRAM   // Telegram only
  WHATSAPP   // WhatsApp only
  BOTH       // Telegram first, WhatsApp as backup
}
